<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Configuration Page</title>
<script type="text/javascript" src="js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
	$('#postDBData')
			.click(
					function(e) {
						e.preventDefault();
						var filepath = document.getElementById("filename").value;
						if ($("#disbDB").attr("value") == 'false') {
							if (filepath == null || filepath == "") {
								pop(
										'popDiv',
										"Please enter valid SNOMED CT Release filepath",
										"");
								return;
							}
						} else {
							//validate inputs for DISB
							if (!validateDISBInputs()) {
								return false;
							}
						}

						var getUrl = window.location;
						var path = getUrl.pathname.split('/');
						var count = path.length;
						var baseUrl = location.protocol + "//" + getUrl.host;
						var errormsg;

						for (var i = 1; i < count - 1; i++) {
							baseUrl = baseUrl + "/" + path[i];
						}
						baseUrl = baseUrl + "/api/add/dbconfig";

						if ($("#disbDB").attr("value") == 'false') {
							pop(
									'popDiv',
									"Please wait..!! It may take few minutes for DB and Index creation.",
									"");
							$("#configDBForm input, #configDBForm select")
									.attr('readonly', true);
							$('#postDBData').prop('disabled', true);

							//for submitting snomed,extension, icd, refset form
							$
									.ajax({
										url : baseUrl,
										type : 'POST',
										dataType : 'html',
										data : $('#configDBForm').serialize(),
										success : function() {
											//$('#configForm').submit();
											pop(
													'popDiv',
													"Form Submitted Successfully.",
													"");
											$(
													"#configDBForm input, #configDBForm select")
													.attr('readonly', false);
											$('#postDBData').prop('disabled',
													false);
											resetData();
										},
										error : function(e) {
											pop('popDiv', e.responseText, "");
											$(
													"#configDBForm input, #configDBForm select")
													.attr('readonly', false);
											$('#postDBData').prop('disabled',
													false);
										}

									});
						} else {
							//for submitting disb form
							pop(
									"popDiv",
									"Please wait. Testing connection using entered inputs.",
									"");
							$("#configDBForm input, #configDBForm select")
									.attr('readonly', true);
							$('#postDBData').prop('disabled', true);

							//for submitting disb form
							$
									.ajax({
										url : baseUrl,
										type : 'POST',
										dataType : 'html',
										data : $('#configDBForm').serialize(),
										success : function() {
											//$('#configForm').submit();
											pop(
													"popDiv",
													"Connection verified with DISB",
													"");
											$(
													"#configDBForm input, #configDBForm select")
													.attr('readonly', false);
											$('#postDBData').prop('disabled',
													false);
											resetData();
											//loadhome();
										},
										error : function(jqXHR, textStatus,
												errorThrown) {
											pop("popDiv", jqXHR.responseText,
													"");
											$(
													"#configDBForm input, #configDBForm select")
													.attr('readonly', false);
											$('#postDBData').prop('disabled',
													false);
										}

									});

						}

					});

	function resetData() {
		$("#protocol").val("");
		$("#hostname").val("");
		$("#portnumber").val("");
		$("#context").val("");
		$("#filename").val("");

	}

	function sleep(milliseconds) {
		var start = new Date().getTime();
		for (var i = 0; i < 1e7; i++) {
			if ((new Date().getTime() - start) > milliseconds) {

				break;
			}
		}
	}

	function redirection() {
		setTimeout(loadhome(), 5000);
	}

	function validateDISBInputs() {
		var protocol = $("#protocol").val();
		var hostname = $("#hostname").val();
		var port = $("#portnumber").val();
		var context = $("#context").val();

		var protocolRGEX = /^[a-zA-Z]+$/;
		if (protocol == null || protocol == "") {
			pop('popDiv', "protocol cannot be empty", "");
			return false;
		} else if (!protocolRGEX.test(protocol)) {
			pop('popDiv', "invalid protocol: " + protocol, "");
			return false;
		}

		//var hostnameRGEX=/^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\\-]*[a-zA-Z0-9])\\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\\-]*[A-Za-z0-9])$/;
		var hostnameRGEX = /^[a-z0-9\.]+$/
		var ipRGEX = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
		if (hostname == null || hostname == "") {
			pop('popDiv', "hostname cannot be empty", "");
			return false;
		} else if (!hostnameRGEX.test(hostname)) {
			//console.log("hostnameRGEX not match");
			if (!ipRGEX.test(hostname)) {
				pop('popDiv', "invalid hostname: " + hostname, "");
				return false;
			}
			//return false;
		}

		var portRGEX = /^[0-9]+$/;
		if (port == null || port == "") {
			pop('popDiv', "port cannot be empty", "");
			return false;
		} else if (!portRGEX.test(port)) {
			pop('popDiv', "invalid port: " + port + " enter number only", "");
			return false;
		}

		var contextRGEX = /^[a-zA-Z/\\_\\.\\-\\d]+$/
		if (context == null || context == "") {
			pop('popDiv', "context cannot be empty", "");
			return false;
		} else if (!contextRGEX.test(context)) {
			pop('popDiv', "invalid context: " + context, "");
			return false;
		}

		return true;
	}

	$("#selectDB").on("change", function() {
		document.getElementById("snomedctDB").value = "false";
		document.getElementById("icdmapDB").value = "false";
		document.getElementById("refsetDB").value = "false";
		document.getElementById("extensionDB").value = "false";
		document.getElementById("disbDB").value = "false";
		document.getElementById("simplemapDB").value = "false";
		document.getElementById("snomedrefsetDB").value = "false";
		document.getElementById("selectOptionDB").value = "false";
		document.getElementById($(this).val() + "DB").value = "true";

		if ($(this).val() == 'disb') {
			showDisbIP();
		} else {
			hideDisbIP();
		}
		$("#snomedctText").hide();
		$("#icdmapText").hide();
		$("#refsetText").hide();
		$("#extensionText").hide();
		$("#disbText").hide();
		$("#simplemapText").hide();
		$("#snomedrefsetText").hide();
		$("#selectOptionDB").hide();
		$("#" + $(this).val() + "Text").show();
	})
	function hideDisbIP() {
		//console.log("hideDisbIP called");
		$("#trProtocol").hide();
		$("#trHostname").hide();
		$("#trPort").hide();
		$("#trContext").hide();
		$("#disbDescription").hide();
		//
		$("#snomedDescription").show();
		$("#filerow").show();
	}

	function showDisbIP() {
		$("#trProtocol").show();
		$("#trHostname").show();
		$("#trPort").show();
		$("#trContext").show();
		$("#disbDescription").show();
		$("#snomedDescription").hide();
		$("#filerow").hide();
	}

	function pop(div, logpath, msg) {
		var error = logpath.split('|');
		document.getElementById('popuplabel').innerHTML = error[0];
		if (typeof error[1] != 'undefined')
			document.getElementById('logpathlabel').innerHTML = error[1];
		document.getElementById(div).style.display = 'block';

		sleep(5000);
	}

	//
	function hidePOPDiv(div) {
		//document.getElementById("okbtn").style.display = 'none';			
		//$("#popDiv").hide();
		document.getElementById("popDiv").style.display = 'none';

	}

	//To detect escape button
	document.onkeydown = function(evt) {
		evt = evt || window.event;
		if (evt.keyCode == 27) {
			hide('popDiv');
		}
	};

	$(document).ready(function() {
		$("#disbDescription").hide();
	});
</script>


<!--  check popup-->
<style>
.ontop {
	z-index: 999;
	width: 100%;
	height: 100%;
	top: 0;
	left: 0;
	display: none;
	position: absolute;
	background-color: #cccccc;
	color: #aaaaaa;
	opacity: .9;
	filter: alpha(opacity = 50);
}

#popup {
	width: 400px;
	height: 90px;
	position: absolute;
	color: #000000;
	background-color: #ffffff;
	/* To align popup window at the center of screen*/
	top: 50%;
	left: 50%;
	margin-top: -100px;
	margin-left: -150px;
	border-radius: 10px
}
</style>




</head>
<body>


	<div class="bar">Configuration Details -</div>

	<div class="detailbar">
		<span class="headings">Description -</span>
		<div id="snomedDescription">
			<span class="simpletext">Please provide the database
				configuration details. Provide the complete filepath after selecting
				the database or table to be created.</span>
		</div>
		<div id="disbDescription">
			<span class="simpletext">Please provide the DISB utility
				configuration details.</span>
		</div>
		<br /> <span class="headings">Form -</span> <br />

		<form action="index.html" method="post" id="configDBForm">

			<table>
				<tr id="CreateDBTable">
					<td>Database Details</td>
				</tr>

				<tr>
					<td>Select option to import/update:</td>
					<td class="tooltip"><select id="selectDB" name="selectDB">
							<option value="selectOption">--Select--</option>
							<option value="snomedct">International Edition</option>
							<option value="snomedrefset">International Reference
								Sets</option>
							<option value="icdmap">SNOMED CT to ICD-10 Map refset</option>
							<option value="refset">Refset file</option>
							<option value="extension">National Extension</option>
							<option value="simplemap">SNOMED CT to Simple Map refset</option>
							<option value="disb">DISB</option>

					</select> <span class="tooltiptext">Select to create/override
							database/table.</span></td>
				</tr>


				<tr id="filerow">
					<td>Release File Path:<span class="require">*</span>
					</td>
					<td><input type="text" id="filename" name="filename" /></td>
				</tr>
				<tr id="trProtocol">
					<td>Protocol:<span class="require">*</span>
					</td>
					<td><input type="text" placeholder="http" id="protocol"
						name="protocol" /></td>
				</tr>
				<tr id="trHostname">
					<td>Hostname: <span class="require">*</span></td>
					<td><input type="text" id="hostname" name="hostname"
						placeholder="localhost" /></td>

				</tr>
				<tr id="trPort">
					<td>Port Number:<span class="require">*</span>
					</td>
					<td><input type="text" id="portnumber" name="portnumber"
						placeholder="9090" /></td>
				</tr>
				<tr id="trContext">
					<td>Context Path: <span class="require">*</span></td>
					<td><input type="text" id="context" name="context"
						placeholder="dis" /></td>
				</tr>

				<tr>
					<td></td>
					<td>
						<div id="selectOptionText" class="labelText"></div>
						<div id="snomedctText" class="labelText" style="display: none">
							<span>e.g.
								C:/Release_file/SnomedCT_InternationalRF2_PRODUCTION_YYYYMMDD/Snapshot</span>
						</div>
						<div id="icdmapText" class="labelText" style="display: none">
							<span>e.g.
								C:/Release_file/SnomedCT_InternationalRF2_PRODUCTION_YYYYMMDD/Snapshot</span>
						</div>
						<div id="refsetText" class="labelText" style="display: none">
							<span>e.g. C:/Release_file/der2_refset_name_YYYYMMDD.txt</span>
						</div>
						<div id="extensionText" class="labelText" style="display: none">
							<span>e.g.
								C:/Release_file/SnomedCT_Extension_YYYYMMDD/Snapshot</span>
						</div>
						<div id="disbText" class="labelText" style="display: none">Provide
							DISB utility details</div>
						<div id="simplemapText" class="labelText" style="display: none">
							<span>e.g.
								C:/Release_file/SnomedCT_Extension_YYYYMMDD/Snapshot</span>
						</div>
						<div id="snomedrefsetText" class="labelText" style="display: none">
							<span>e.g.
								C:/Release_file/SnomedCT_InternationalRF2_PRODUCTION_YYYYMMDD/Snapshot</span>
						</div>
					</td>
				</tr>
			</table>

			<div>
				<!-- extra default parameter for identifying db type  -->
				<input type="hidden" id="selectOptionDB" name="selectOptionDB"
					value="true" /> <input type="hidden" id="snomedctDB"
					name="snomedctDB" value="false" /> <input type="hidden"
					id="icdmapDB" name="icdmapDB" value="false" /> <input type="hidden"
					id="refsetDB" name="refsetDB" value="false" /> <input
					type="hidden" id="extensionDB" name="extensionDB" value="false" />
				<input type="hidden" id="simplemapDB" name="simplemapDB"
					value="false" /> <input type="hidden" id="disbDB" name="disbDB"
					value="false" /> <input type="hidden" id="snomedrefsetDB"
					name="snomedrefsetDB" value="false" />
			</div>
			<button type="button" value="Submit" id="postDBData">Submit</button>



			<!--  check popup -->
			<div id="popDiv" class="ontop">
				<table border="1" id="popup">
					<tr>
						<td style="text-align: center;"><label id="popuplabel"></label>
							<br> <label id="logpathlabel"></label> <br> <input
							type="button" id="okbtn" onclick="hidePOPDiv(this)" value="OK"
							style="width: 45px; background-color: cornflowerblue; color: white;">
							</td>
					</tr>

				</table>
			</div>
		</form>
	</div>

	<script type="text/javascript">
	$(document).ready(function(){
		hideDisbIP();
	});	
	</script>
</body>
</html>